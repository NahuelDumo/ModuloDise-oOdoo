<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Grupo de usuario Diseñador -->
    <record id="group_disenador" model="res.groups">
        <field name="name">Diseñador</field>
        <field name="category_id" ref="base.module_category_services_project"/>
    </record>

    <!-- Grupo de usuario Validador -->
    <record id="group_validador" model="res.groups">
        <field name="name">Validador</field>
        <field name="category_id" ref="base.module_category_services_project"/>
        <field name="users" eval="[(4, ref('base.user_admin'))]"/>
    </record>

    <!-- Grupo de usuario Cliente -->
    <record id="group_cliente" model="res.groups">
        <field name="name">Cliente</field>
        <field name="category_id" ref="base.module_category_services_project"/>
    </record>

    <!-- Reglas de acceso para los modelos -->
    
    <!-- Regla para diseñadores - pueden ver todos los diseños pero editar solo los suyos -->
    <record id="design_design_rule_disenador" model="ir.rule">
        <field name="name">Diseñador: acceso a diseños</field>
        <field name="model_id" search="[('model', '=', 'design.design')]" model="ir.model"/>
        <field name="domain_force">[(1, '=', 1)]</field>
        <field name="groups" eval="[(4, ref('group_disenador'))]"/>
        <field name="perm_read" eval="True"/>
        <field name="perm_write" eval="True"/>
        <field name="perm_create" eval="True"/>
        <field name="perm_unlink" eval="False"/>
    </record>

    <!-- Regla para validadores - acceso total de lectura y escritura -->
    <record id="design_design_rule_validador" model="ir.rule">
        <field name="name">Validador: acceso total a diseños</field>
        <field name="model_id" search="[('model', '=', 'design.design')]" model="ir.model"/>
        <field name="domain_force">[(1, '=', 1)]</field>
        <field name="groups" eval="[(4, ref('group_validador'))]"/>
        <field name="perm_read" eval="True"/>
        <field name="perm_write" eval="True"/>
        <field name="perm_create" eval="False"/>
        <field name="perm_unlink" eval="False"/>
    </record>

    <!-- Regla para clientes - solo pueden ver sus propios diseños en estados específicos -->
    <record id="design_design_rule_cliente" model="ir.rule">
        <field name="name">Cliente: acceso a sus propios diseños</field>
        <field name="model_id" search="[('model', '=', 'design.design')]" model="ir.model"/>
        <field name="domain_force">[
            '&amp;',
                '|',
                    ('cliente_id', '=', user.partner_id.id),
                    ('cliente_id', 'child_of', user.partner_id.commercial_partner_id.id),
            '&amp;',
                ('visible_para_cliente', '=', True),
                ('state', 'in', ['cliente', 'correcciones_solicitadas', 'aprobado', 'rechazado', 'esperando_cliente'])
        ]</field>
        <field name="groups" eval="[(4, ref('group_cliente'))]"/>
        <field name="perm_read" eval="True"/>
        <field name="perm_write" eval="False"/>
        <field name="perm_create" eval="False"/>
        <field name="perm_unlink" eval="False"/>
    </record>
    
    <!-- Regla para usuarios del portal - misma regla que para clientes -->
    <record id="design_design_rule_portal" model="ir.rule">
        <field name="name">Portal: acceso a diseños del cliente</field>
        <field name="model_id" ref="model_design_design"/>
        <field name="domain_force">[
            '&amp;',
                '|',
                    ('cliente_id', '=', user.partner_id.id),
                    ('cliente_id', 'child_of', user.partner_id.commercial_partner_id.id),
            '&amp;',
                ('visible_para_cliente', '=', True),
                ('state', 'in', ['cliente', 'correcciones_solicitadas', 'aprobado', 'rechazado', 'esperando_cliente'])
        ]</field>
        <field name="groups" eval="[(4, ref('base.group_portal'))]"/>
        <field name="perm_read" eval="True"/>
        <field name="perm_write" eval="False"/>
        <field name="perm_create" eval="False"/>
        <field name="perm_unlink" eval="False"/>
    </record>

    <!-- Regla para usuarios internos - acceso completo -->
    <record id="design_design_rule_user" model="ir.rule">
        <field name="name">Usuario interno: acceso a diseños</field>
        <field name="model_id" ref="model_design_design"/>
        <field name="domain_force">[(1, '=', 1)]</field>
        <field name="groups" eval="[(4, ref('base.group_user'))]"/>
        <field name="perm_read" eval="True"/>
        <field name="perm_write" eval="True"/>
        <field name="perm_create" eval="False"/>
        <field name="perm_unlink" eval="False"/>
    </record>
    
    <!-- Regla para administradores - permiso para eliminar diseños -->
    <record id="design_design_rule_admin" model="ir.rule">
        <field name="name">Administrador: eliminar diseños</field>
        <field name="model_id" ref="model_design_design"/>
        <field name="domain_force">[(1, '=', 1)]</field>
        <field name="groups" eval="[(4, ref('base.group_system'))]"/>
        <field name="perm_read" eval="True"/>
        <field name="perm_write" eval="True"/>
        <field name="perm_create" eval="False"/>
        <field name="perm_unlink" eval="True"/>
    </record>

    <!-- Reglas para checklist items -->
    <record id="design_checklist_item_rule_disenador" model="ir.rule">
        <field name="name">Diseñador: acceso a checklist items</field>
        <field name="model_id" search="[('model', '=', 'design.checklist_item')]" model="ir.model"/>
        <field name="domain_force">[(1, '=', 1)]</field>
        <field name="groups" eval="[(4, ref('group_disenador'))]"/>
        <field name="perm_read" eval="True"/>
        <field name="perm_write" eval="True"/>
        <field name="perm_create" eval="True"/>
        <field name="perm_unlink" eval="True"/>
    </record>

    <record id="design_checklist_item_rule_validador" model="ir.rule">
        <field name="name">Validador: acceso a checklist items</field>
        <field name="model_id" search="[('model', '=', 'design.checklist_item')]" model="ir.model"/>
        <field name="domain_force">[(1, '=', 1)]</field>
        <field name="groups" eval="[(4, ref('group_validador'))]"/>
        <field name="perm_read" eval="True"/>
        <field name="perm_write" eval="True"/>
        <field name="perm_create" eval="True"/>
        <field name="perm_unlink" eval="True"/>
    </record>

    <!-- Reglas para revision log -->
    <record id="design_revision_log_rule_disenador" model="ir.rule">
        <field name="name">Diseñador: acceso a revision log</field>
        <field name="model_id" search="[('model', '=', 'design.revision_log')]" model="ir.model"/>
        <field name="domain_force">[(1, '=', 1)]</field>
        <field name="groups" eval="[(4, ref('group_disenador'))]"/>
        <field name="perm_read" eval="True"/>
        <field name="perm_write" eval="True"/>
        <field name="perm_create" eval="True"/>
        <field name="perm_unlink" eval="False"/>
    </record>

    <record id="design_revision_log_rule_validador" model="ir.rule">
        <field name="name">Validador: acceso a revision log</field>
        <field name="model_id" search="[('model', '=', 'design.revision_log')]" model="ir.model"/>
        <field name="domain_force">[(1, '=', 1)]</field>
        <field name="groups" eval="[(4, ref('group_validador'))]"/>
        <field name="perm_read" eval="True"/>
        <field name="perm_write" eval="True"/>
        <field name="perm_create" eval="True"/>
        <field name="perm_unlink" eval="False"/>
    </record>

    <record id="design_revision_log_rule_cliente" model="ir.rule">
        <field name="name">Cliente: acceso a revision log</field>
        <field name="model_id" search="[('model', '=', 'design.revision_log')]" model="ir.model"/>
        <field name="domain_force">[('design_id.visible_para_cliente', '=', True)]</field>
        <field name="groups" eval="[(4, ref('group_cliente'))]"/>
        <field name="perm_read" eval="True"/>
        <field name="perm_write" eval="False"/>
        <field name="perm_create" eval="False"/>
        <field name="perm_unlink" eval="False"/>
    </record>

    <!-- Regla para mensajes del portal - solo comentarios desde estado cliente -->
    <!-- Regla para que el cliente solo vea NOTAS del chatter (no mensajes automáticos) -->
    <record id="mail_message_rule_portal" model="ir.rule">
        <field name="name">Portal: solo notas del chatter</field>
        <field name="model_id" ref="mail.model_mail_message"/>
        <field name="domain_force">[
            ('model', '=', 'design.design'),
            ('message_type', '=', 'comment')
        ]</field>
        <field name="groups" eval="[(4, ref('base.group_portal'))]"/>
        <field name="perm_read" eval="True"/>
        <field name="perm_write" eval="False"/>
        <field name="perm_create" eval="False"/>
        <field name="perm_unlink" eval="False"/>
    </record>

    <!-- Regla para adjuntos - Solo de notas -->
    <record id="ir_attachment_rule_portal" model="ir.rule">
        <field name="name">Portal: adjuntos de notas</field>
        <field name="model_id" ref="base.model_ir_attachment"/>
        <field name="domain_force">[
            ('res_model', '=', 'design.design'),
            ('res_field', '=', 'attachment_ids')
        ]</field>
        <field name="groups" eval="[(4, ref('base.group_portal'))]"/>
        <field name="perm_read" eval="True"/>
        <field name="perm_write" eval="False"/>
        <field name="perm_create" eval="False"/>
        <field name="perm_unlink" eval="False"/>
    </record>
</odoo>